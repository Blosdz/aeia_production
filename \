<!-- resources/views/admin_funciones/fondo_clientes.blade.php -->

@extends('layouts.app')

@section('content')
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div style="width: 75%; margin: auto;">
        <h2>Historial de Inversiones del Cliente: {{ $user->name }}</h2>
        
        <!-- Formulario para seleccionar el fondo -->
        <form action="{{ route('home') }}" method="GET">
            <label for="fondo_id">Seleccionar Fondo:</label>
            <select name="fondo_id" id="fondo_id" class="form-control" onchange="this.form.submit()">
                <option value="">Seleccione un fondo</option>
                @foreach ($find_plans as $plan)
                    <option value="{{ $plan->id }}" {{ $plan->id == $fondoId ? 'selected' : '' }}>
                        {{ $mapPlan[$plan->plan_id] }} - {{ $plan->month }} - Fondo - {{ $plan->plan_id_fondo }}

                    </option>
                @endforeach
            </select>
            <noscript><input type="submit" value="Seleccionar Fondo"></noscript>
        </form>

        @if ($fondoId)
            <!-- Mostrar datos del fondo seleccionado -->
            <div class="fondo-details">
                @foreach ($find_plans as $plan)
                    @if ($plan->id == $fondoId)
                        <h3>Detalles del Fondo Seleccionado</h3>
                        <p>Nombre: {{ $plan->nombre }}</p>
                        <p>Monto Invertido: {{ $plan->monto_invertido }}</p>
                        <p>Ganancia: {{ $plan->ganancia }}</p>
                        <p>Rentabilidad: {{ $plan->rentabilidad }}</p>
                    @endif
                @endforeach
            </div>

            <!-- Botón para mostrar el gráfico -->
            <button onclick="document.getElementById('clientHistoryChartContainer').style.display='block'">
                Movimientos del Fondo
            </button>

            <!-- Gráfico -->
            <div id="clientHistoryChartContainer" style="display: none;">
                <canvas id="clientHistoryChart"></canvas>
            </div>
        @endif
    </div>

    @if ($fondoId)
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var ctx = document.getElementById('clientHistoryChart').getContext('2d');
                
                var labels = {!! json_encode($historialClientes->pluck('created_at')->toArray()) !!};
                var totalActual = {!! json_encode($historialClientes->map(function($historial) {
                    return $historial->total_invertido + $historial->ganancia;
                })->toArray()) !!};

                // Capital inicial
                var capitalInicial = {!! json_encode([$historialClientes->first()->total_invertido]) !!};

                // Agregar el capital inicial solo una vez al inicio
                labels.unshift('Capital Inicial');
                totalActual.unshift(capitalInicial[0]);

                var clientHistoryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
		        labels: labels.map(date => moment(date).format('MMM D')),
                        datasets: [
                            {
                                label: 'Capital Inicial',
                                data: capitalInicial, // Mostrar capital inicial solo una vez
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Total Actual',
                                data: totalActual, // Mostrar los valores totales actuales
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        </script>
    @endif
@endsection
